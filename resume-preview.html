<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Resume Preview</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Merriweather&family=Montserrat:wght@500&family=Roboto+Mono&display=swap" rel="stylesheet">

<style>
body{
    margin:0;
    background:linear-gradient(135deg,#6a0dad,#9b59b6);
    font-family:Arial,sans-serif;
    padding:40px;
}
.container{
    max-width:1200px;
    margin:auto;
    display:flex;
    gap:25px;
}
.actions{
    width:220px;
    background:#fff;
    padding:25px;
    border-radius:14px;
}
.actions button{
    width:100%;
    padding:12px;
    margin-bottom:12px;
    border-radius:8px;
    border:none;
    cursor:pointer;
}
.download-btn{background:#6a0dad;color:#fff}

.resume{
    flex:1;
    background:#fff;
    padding:40px;
    border-radius:18px;
    display:none;
}

/* ===== TEMPLATES ===== */
.template-clean{font-family:Merriweather;}
.template-clean h1{font-size:32px}
.template-clean h3{border-bottom:2px solid #000}



.template-ats{font-family:Arial;font-size:14px}
.template-ats h3{text-transform:uppercase;border-bottom:1px solid #000;font-size:13px}

.template-modern{font-family:Poppins}
.template-modern h1{color:#3498db}
.template-modern h3{border-bottom:2px solid #3498db}

.template-executive{font-family:Montserrat}
.template-executive h1{text-align:center}
.template-executive section{background:#f8f8f8;padding:15px;border-radius:8px;margin-bottom:15px}



.template-technical{font-family:Roboto Mono}
.template-technical h3{background:#eee;padding:6px}

.template-academic{font-family:Merriweather}
.template-academic h1{font-size:28px;letter-spacing:1px}


.template-corporate{font-family:Arial}
.template-corporate section{border-left:6px solid #6a0dad;padding-left:15px;margin-bottom:18px}

@media print{
    body{background:none;padding:0}
    .actions{display:none}
}
</style>
</head>

<body>

<div class="container">

<!-- ACTIONS -->
<div class="actions">
    <button onclick="editResume()">Edit Resume</button>
    <button onclick="goToDashboard()">Go to Dashboard</button>
    <button onclick="changeTemplate()">Change Template</button>
<button onclick="printResume()" class="download-btn">
    Download / Print
</button>


</div>

<!-- ===== TEMPLATES (UNCHANGED) ===== -->
<div class="resume template-clean" id="t0">
    <h1 id="n"></h1><p id="c"></p>
    <h3>Summary</h3><p id="s"></p>
    <h3>Experience</h3><p id="e"></p>
    <h3>Education</h3><p id="ed"></p>
    <h3>Skills</h3><ul id="sk"></ul>
</div>



<div class="resume template-ats" id="t2">
<h1 id="n2"></h1><p id="c2"></p>
<h3>Summary</h3><p id="s2"></p>
<h3>Experience</h3><p id="e2"></p>
<h3>Education</h3><p id="ed2"></p>
<h3>Skills</h3><p id="sk2"></p>
</div>

<div class="resume template-modern" id="t3">
<h1 id="n3"></h1><p id="c3"></p>
<h3>Summary</h3><p id="s3"></p>
<h3>Experience</h3><p id="e3"></p>
<h3>Education</h3><p id="ed3"></p>
<h3>Skills</h3><ul id="sk3"></ul>
</div>



<div class="resume template-technical" id="t6">
<h1 id="n6"></h1><p id="c6"></p>
<h3>Summary</h3><p id="s6"></p>
<h3>Experience</h3><p id="e6"></p>
<h3>Education</h3><p id="ed6"></p>
<h3>Skills</h3><ul id="sk6"></ul>
</div>

<div class="resume template-academic" id="t7">
<h1 id="n7"></h1><p id="c7"></p>
<h3>Summary</h3><p id="s7"></p>
<h3>Experience</h3><p id="e7"></p>
<h3>Education</h3><p id="ed7"></p>
<h3>Skills</h3><ul id="sk7"></ul>
</div>


<div class="resume template-corporate" id="t9">
<h1 id="n9"></h1><p id="c9"></p>
<section><h3>Summary</h3><p id="s9"></p></section>
<section><h3>Experience</h3><p id="e9"></p></section>
<section><h3>Education</h3><p id="ed9"></p></section>
<section><h3>Skills</h3><ul id="sk9"></ul></section>
</div>

</div>


<script>
console.log(
  "[AUTH CHECK]",
  location.pathname,
  localStorage.getItem("loggedUser")
);

const API = "http://localhost:5000";
const user = JSON.parse(localStorage.getItem("loggedUser"));
if (!user || !user.id) {
    alert("User not logged in");
    location.href = "login.html";
}

/* ================= GLOBAL STATE ================= */
const historyId = localStorage.getItem("historyResumeId");
let data = null;
let index = 0;

/* TEMPLATE â†’ FIELD ID SUFFIX */
const TEMPLATE_CONFIG = {
    clean:      { index: 0, suffix: "" },
    ats:        { index: 1, suffix: "2" },
    modern:     { index: 2, suffix: "3" },
    technical:  { index: 3, suffix: "6" },
    academic:   { index: 4, suffix: "7" },
    corporate:  { index: 5, suffix: "9" }
};

const templates = document.querySelectorAll(".resume");

/* ================= LOAD RESUME ================= */
async function loadResume() {
    try {
        let selectedTemplate = "clean";

        if (historyId) {
            const res = await fetch(`${API}/resume/${historyId}`);
            const r = await res.json();

            data = JSON.parse(r.resume_data);
            selectedTemplate = r.template_name || "clean";

            localStorage.removeItem("historyResumeId");
        } else {
            data = JSON.parse(localStorage.getItem("resumeData"));
            selectedTemplate = localStorage.getItem("selectedTemplate") || "clean";
        }

        if (!data) {
            alert("No resume found");
            location.href = "dashboard.html";
            return;
        }

        renderTemplate(selectedTemplate);
    } catch (err) {
        console.error("Resume load error:", err);
        alert("Failed to load resume");
        location.href = "dashboard.html";
    }
}

/* ================= RENDER ================= */
function renderTemplate(templateKey) {
    const cfg = TEMPLATE_CONFIG[templateKey] || TEMPLATE_CONFIG.clean;
    const s = cfg.suffix;

    templates.forEach(t => t.style.display = "none");
    templates[cfg.index].style.display = "block";

    setText("n" + s, data.name);
    setText("c" + s, `${data.email || ""} | ${data.phone || ""}`);
    setText("s" + s, data.summary);
    setText("e" + s, data.experience);
    setText("ed" + s, data.education);

    const sk = document.getElementById("sk" + s);
    if (sk) {
        sk.innerHTML = "";
        (data.skills || "").split(/,|\n/).forEach(skill => {
            if (skill.trim()) {
                const li = document.createElement("li");
                li.textContent = skill.trim();
                sk.appendChild(li);
            }
        });
    }

    index = cfg.index;
}

function setText(id, value) {
    const el = document.getElementById(id);
    if (el) el.textContent = value || "";
}

/* ================= ACTIONS ================= */
function changeTemplate() {
    const keys = Object.keys(TEMPLATE_CONFIG);
    const currentKey = keys.find(k => TEMPLATE_CONFIG[k].index === index) || "clean";
    const nextKey = keys[(keys.indexOf(currentKey) + 1) % keys.length];

    localStorage.setItem("selectedTemplate", nextKey);
    renderTemplate(nextKey);
}

function editResume() {
    location.href = "form-edit.html";
}

function goToDashboard() {
    location.href = "dashboard.html";
}

/* ================= PRINT & SAVE ================= */
async function printResume() {
    const templateKey =
        Object.keys(TEMPLATE_CONFIG).find(
            k => TEMPLATE_CONFIG[k].index === index
        ) || "clean";

    await fetch(`${API}/resume/save`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            userId: user.id,
            resumeName: `Resume - ${new Date().toLocaleString()}`,
            resumeData: data,
            pdf_base64: "PRINTED",
            template_name: templateKey
        })
    });

    window.print();
}

/* ================= START ================= */
loadResume();
</script>



</body>
</html>
